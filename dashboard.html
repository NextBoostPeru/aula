<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Dashboard | Aula Virtual</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <!-- Topbar -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="inline-flex items-center justify-center w-9 h-9 rounded-xl bg-indigo-600 text-white">
          <i data-feather="layers"></i>
        </span>
        <h1 class="text-lg font-semibold">Aula Virtual</h1>
      </div>
      <div class="flex items-center gap-4">
        <button id="btnNotifications" class="relative p-2 rounded-lg hover:bg-gray-100" data-section="notificaciones">
          <i data-feather="bell"></i>
          <span id="notifDot" class="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-red-500 rounded-full hidden"></span>
        </button>
        <button id="logoutBtn" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-900 text-white hover:bg-black">
          <i data-feather="log-out"></i> Salir
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-12 gap-6">
    <!-- Sidebar -->
    <aside class="col-span-12 lg:col-span-3">
      <nav class="bg-white rounded-2xl shadow p-2">
        <button class="w-full flex items-center gap-2 p-3 rounded-xl hover:bg-indigo-50 text-gray-700 section-btn" data-section="cursos">
          <i data-feather="book"></i> <span>Mis Cursos</span>
        </button>
        <button class="w-full flex items-center gap-2 p-3 rounded-xl hover:bg-indigo-50 text-gray-700 section-btn" data-section="modulos">
          <i data-feather="list"></i> <span>Módulos</span>
        </button>
        <button class="w-full flex items-center gap-2 p-3 rounded-xl hover:bg-indigo-50 text-gray-700 section-btn" data-section="asistencias">
          <i data-feather="check-circle"></i> <span>Asistencias</span>
        </button>
        <button class="w-full flex items-center gap-2 p-3 rounded-xl hover:bg-indigo-50 text-gray-700 section-btn" data-section="notas">
          <i data-feather="trending-up"></i> <span>Notas</span>
        </button>
        <button class="w-full flex items-center gap-2 p-3 rounded-xl hover:bg-indigo-50 text-gray-700 section-btn" data-section="pagos">
          <i data-feather="credit-card"></i> <span>Pagos</span>
        </button>
        <button class="w-full flex items-center gap-2 p-3 rounded-xl hover:bg-indigo-50 text-gray-700 section-btn" data-section="perfil">
          <i data-feather="user"></i> <span>Perfil</span>
        </button>
        <button class="w-full flex items-center gap-2 p-3 rounded-xl hover:bg-indigo-50 text-gray-700 section-btn" data-section="certificados">
          <i data-feather="award"></i> <span>Certificados</span>
        </button>
        <button class="w-full flex items-center gap-2 p-3 rounded-xl hover:bg-indigo-50 text-gray-700 section-btn" data-section="notificaciones">
          <i data-feather="bell"></i> <span>Notificaciones</span>
        </button>
      </nav>
    </aside>

    <!-- Content -->
    <section class="col-span-12 lg:col-span-9 space-y-6">
      <div class="flex items-center justify-between">
        <h2 id="sectionTitle" class="text-xl font-semibold">Mis Cursos</h2>
        <div id="sectionActions"></div>
      </div>
      <div id="sectionContent" class="space-y-6"></div>
    </section>
  </main>

  <!-- Modal genérico -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg shadow-xl">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 id="modalTitle" class="text-lg font-semibold">Título</h3>
        <button id="modalClose" class="p-2 hover:bg-gray-100 rounded-lg"><i data-feather="x"></i></button>
      </div>
      <div id="modalBody" class="p-4"></div>
      <div class="p-4 border-t text-right">
        <button id="modalCancel" class="px-4 py-2 rounded-lg border hover:bg-gray-50">Cerrar</button>
        <button id="modalPrimary" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 hidden">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    feather.replace();

    // --- Helpers UI ---
    const sectionTitle = document.getElementById('sectionTitle');
    const sectionContent = document.getElementById('sectionContent');
    const sectionActions = document.getElementById('sectionActions');
    const notifDot = document.getElementById('notifDot');

    function card(title, body, footer = '') {
      return `
        <div class="bg-white rounded-2xl shadow p-4">
          <h3 class="text-base font-semibold mb-2">${title}</h3>
          <div class="text-sm text-gray-700">${body}</div>
          ${footer ? `<div class="pt-3 mt-3 border-t">${footer}</div>` : ''}
        </div>
      `;
    }
    function table(heads, rowsHtml) {
      const th = heads.map(h => `<th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">${h}</th>`).join('');
      return `
        <div class="overflow-auto bg-white rounded-2xl shadow">
          <table class="min-w-full text-sm">
            <thead class="border-b"><tr>${th}</tr></thead>
            <tbody class="divide-y">${rowsHtml}</tbody>
          </table>
        </div>
      `;
    }
    function openModal(title, html, primaryLabel=null, onPrimary=null) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').innerHTML = html;
      const primaryBtn = document.getElementById('modalPrimary');
      if (primaryLabel && onPrimary) {
        primaryBtn.textContent = primaryLabel;
        primaryBtn.classList.remove('hidden');
        primaryBtn.onclick = onPrimary;
      } else {
        primaryBtn.classList.add('hidden');
        primaryBtn.onclick = null;
      }
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden'); modal.classList.add('flex');
      feather.replace();
    }
    function closeModal() {
      const modal = document.getElementById('modal');
      modal.classList.add('hidden'); modal.classList.remove('flex');
    }
    document.getElementById('modalClose').onclick = closeModal;
    document.getElementById('modalCancel').onclick = closeModal;

    async function fetchJSON(url, opt={}) {
      const res = await fetch(url, opt);
      if (!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }

    // === MIS CURSOS (solo lectura) ===
    async function renderCursos() {
      sectionTitle.textContent = 'Mis Cursos';
      sectionActions.innerHTML = '';

      let cursos = [];
      try {
        const j = await fetchJSON('../backend/courses_my.php');
        cursos = j.data || [];
      } catch (e) { cursos = []; }

      if (!cursos.length) {
        sectionContent.innerHTML = card('Sin cursos', 'Todavía no estás matriculado en ningún curso.');
        feather.replace(); return;
      }

      const items = cursos.map(item => {
        const hasModulo = !!item.modulo;
        const pct = Math.round((item.progress || 0)*100);
        const infoCurso = `
          <div class="grid md:grid-cols-2 gap-3">
            <div><div class="text-gray-600">Sede</div><div class="font-medium">${item.curso.sede}</div></div>
            <div><div class="text-gray-600">Aula</div><div class="font-medium">${item.curso.aula}</div></div>
            ${hasModulo ? `
            <div><div class="text-gray-600">Módulo</div><div class="font-medium">#${item.modulo.numero} — ${item.modulo.titulo}</div></div>
            <div><div class="text-gray-600">Inicio / Fin</div><div class="font-medium">${item.periodo.inicio} → ${item.periodo.fin}</div></div>
            ` : `<div class="md:col-span-2 text-yellow-700 bg-yellow-50 border border-yellow-200 rounded-xl p-2">No tienes un módulo activo.</div>`}
          </div>`;
        const barraProgreso = hasModulo ? `
          <div class="mt-3">
            <div class="flex items-center justify-between"><span class="text-gray-600">Progreso</span><span class="font-medium">${pct}%</span></div>
            <div class="w-full h-2 bg-gray-100 rounded-full"><div class="h-2 rounded-full bg-indigo-600" style="width:${pct}%"></div></div>
          </div>` : '';
        const fechasClases = hasModulo ? `
          <div class="mt-3">
            <div class="text-gray-600 mb-1">Fechas de clases (1/semana)</div>
            <ul class="grid sm:grid-cols-2 gap-1 text-sm">
              ${item.clases.map(c => `<li>Clase ${c.nro}: <span class="font-medium">${c.date}</span></li>`).join('')}
            </ul>
            ${item.modulo.next_class_date ? `<div class="mt-2 text-sm">Próxima clase: <span class="font-medium">${item.modulo.next_class_date}</span></div>` : ''}
            <div class="mt-3 flex flex-wrap gap-2">
              <a href="${item.links?.video || '#'}" class="inline-flex items-center gap-1 px-3 py-2 rounded-lg border hover:bg-gray-50"><i data-feather="play"></i> Video</a>
              <a href="${item.links?.pdf || '#'}" class="inline-flex items-center gap-1 px-3 py-2 rounded-lg border hover:bg-gray-50"><i data-feather="file-text"></i> PDF</a>
              <a href="${item.links?.slides || '#'}" class="inline-flex items-center gap-1 px-3 py-2 rounded-lg border hover:bg-gray-50"><i data-feather="sliders"></i> Diapositivas</a>
            </div>
          </div>` : '';
        return card(item.curso.titulo, infoCurso + barraProgreso + fechasClases, '');
      }).join('');

      sectionContent.innerHTML = items;
      feather.replace();
    }

    // === MÓDULOS (con materiales; resalta activo) ===
    async function renderModulos() {
      sectionTitle.textContent = 'Módulos';
      sectionActions.innerHTML = '';

      let grupos = [];
      try {
        const j = await fetchJSON('../backend/modules_all_my.php');
        grupos = j.data || [];
      } catch (e) { grupos = []; }

      if (!grupos.length) {
        sectionContent.innerHTML = `<div class="bg-white rounded-2xl p-6 shadow text-sm text-gray-700">No hay matrículas ni módulos disponibles.</div>`;
        feather.replace(); return;
      }

      const html = grupos.map(g => {
        const rows = (g.modulos || []).map(m => {
          const active = (g.active_modulo_id === m.id);
          const btns = `
            <div class="flex items-center gap-2">
              ${m.video_url ? `<a href="${m.video_url}" target="_blank" class="inline-flex items-center gap-1 px-2 py-1 rounded-lg border hover:bg-gray-50"><i data-feather="play"></i><span class="hidden sm:inline">Video</span></a>` : `<span class="text-xs text-gray-400">—</span>`}
              ${m.pdf_url ? `<a href="${m.pdf_url}" target="_blank" class="inline-flex items-center gap-1 px-2 py-1 rounded-lg border hover:bg-gray-50"><i data-feather="file-text"></i><span class="hidden sm:inline">PDF</span></a>` : `<span class="text-xs text-gray-400">—</span>`}
              ${m.slides_url ? `<a href="${m.slides_url}" target="_blank" class="inline-flex items-center gap-1 px-2 py-1 rounded-lg border hover:bg-gray-50"><i data-feather="sliders"></i><span class="hidden sm:inline">Diapositivas</span></a>` : `<span class="text-xs text-gray-400">—</span>`}
            </div>`;
          return `
            <tr class="${active ? 'bg-indigo-50' : ''}">
              <td class="px-3 py-2">#${m.numero}</td>
              <td class="px-3 py-2">${m.titulo}</td>
              <td class="px-3 py-2">${btns}</td>
              <td class="px-3 py-2">${active ? '<span class="inline-flex items-center px-2 py-0.5 rounded-lg border bg-green-100 text-green-700 border-green-200 text-xs">Activo</span>' : '<span class="text-xs text-gray-400">—</span>'}</td>
            </tr>`;
        }).join('');

        return `
          <div class="bg-white rounded-2xl shadow p-4 space-y-3">
            <div>
              <h3 class="text-base font-semibold">${g.curso.titulo}</h3>
              <div class="text-xs text-gray-500">Sede: ${g.curso.sede} · Aula: ${g.curso.aula}</div>
            </div>
            <div class="overflow-auto">
              <table class="min-w-full text-sm">
                <thead class="border-b">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">#</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Módulo</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Materiales</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Estado</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  ${rows || '<tr><td colspan="4" class="px-3 py-2 text-gray-500">Sin módulos</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>`;
      }).join('');

      sectionContent.innerHTML = html;
      feather.replace();
    }

    // === ASISTENCIAS (lee attendance_my.php) ===
    async function renderAsistencias() {
      sectionTitle.textContent = 'Asistencias';
      sectionActions.innerHTML = '';

      let grupos = [];
      try {
        const j = await fetch('../backend/attendance_my.php').then(r=>r.json());
        grupos = j.data || [];
      } catch(e) { grupos = []; }

      if (!grupos.length) {
        sectionContent.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow text-sm text-gray-700">
            No hay datos de asistencias por ahora.
          </div>`;
        feather.replace(); return;
      }

      const badge = (st) => {
        if (st==='asistio')      return '<span class="inline-flex px-2 py-0.5 rounded-lg border bg-green-100 text-green-700 border-green-200 text-xs">Asistió</span>';
        if (st==='tarde')        return '<span class="inline-flex px-2 py-0.5 rounded-lg border bg-yellow-100 text-yellow-700 border-yellow-200 text-xs">Tarde</span>';
        if (st==='falta')        return '<span class="inline-flex px-2 py-0.5 rounded-lg border bg-red-100 text-red-700 border-red-200 text-xs">Falta</span>';
        if (st==='justificado')  return '<span class="inline-flex px-2 py-0.5 rounded-lg border bg-blue-100 text-blue-700 border-blue-200 text-xs">Justificado</span>';
        if (st==='no_aplica')    return '<span class="inline-flex px-2 py-0.5 rounded-lg border bg-gray-100 text-gray-600 border-gray-200 text-xs">No aplica</span>';
        if (st==='pendiente')    return '<span class="inline-flex px-2 py-0.5 rounded-lg border bg-orange-100 text-orange-700 border-orange-200 text-xs">Pendiente</span>';
        return '<span class="inline-flex px-2 py-0.5 rounded-lg border bg-gray-100 text-gray-600 border-gray-200 text-xs">Programada</span>';
      };

      const html = grupos.map(g => {
        const rows = (g.clases || []).map(c => `
          <tr>
            <td class="px-3 py-2">Clase ${c.nro}</td>
            <td class="px-3 py-2">${c.date}</td>
            <td class="px-3 py-2">${badge(c.status)}</td>
          </tr>
        `).join('');

        return `
          <div class="bg-white rounded-2xl shadow p-4 space-y-3">
            <div>
              <h3 class="text-base font-semibold">${g.curso.titulo}</h3>
              <div class="text-xs text-gray-500">Sede: ${g.curso.sede} · Aula: ${g.curso.aula}</div>
              ${g.modulo ? `<div class="text-xs text-gray-500 mt-1">Módulo activo desde <span class="font-medium">${g.modulo.start_date}</span></div>` : `<div class="text-xs text-gray-500 mt-1">Sin módulo activo</div>`}
            </div>
            <div class="overflow-auto">
              <table class="min-w-full text-sm">
                <thead class="border-b">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Sesión</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Fecha</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Estado</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  ${rows || '<tr><td colspan="3" class="px-3 py-2 text-gray-500">No hay clases que mostrar</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');

      sectionContent.innerHTML = html;
      feather.replace();
    }

    // === NOTAS (lee grades_my.php) ===
    async function renderNotas() {
      sectionTitle.textContent = 'Notas';
      sectionActions.innerHTML = '';

      let grupos = [];
      try {
        const j = await fetch('../backend/grades_my.php').then(r=>r.json());
        grupos = j.data || [];
      } catch(e) { grupos = []; }

      if (!grupos.length) {
        sectionContent.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow text-sm text-gray-700">
            No hay notas disponibles por ahora.
          </div>`;
        feather.replace(); return;
      }

      const badgeProm = (v) => {
        if (v === null) return '<span class="inline-flex px-2 py-0.5 rounded-lg border bg-gray-100 text-gray-600 border-gray-200 text-xs">Sin promedio</span>';
        if (v >= 14) return `<span class="inline-flex px-2 py-0.5 rounded-lg border bg-green-100 text-green-700 border-green-200 text-xs">Promedio: ${v}</span>`;
        if (v >= 11) return `<span class="inline-flex px-2 py-0.5 rounded-lg border bg-yellow-100 text-yellow-700 border-yellow-200 text-xs">Promedio: ${v}</span>`;
        return `<span class="inline-flex px-2 py-0.5 rounded-lg border bg-red-100 text-red-700 border-red-200 text-xs">Promedio: ${v}</span>`;
      };

      const html = grupos.map(g => {
        const rows = (g.modulos || []).map(m => `
          <tr>
            <td class="px-3 py-2">#${m.numero}</td>
            <td class="px-3 py-2">${m.titulo}</td>
            <td class="px-3 py-2">${m.nota !== null ? Number(m.nota).toFixed(2) : '—'}</td>
            <td class="px-3 py-2">
              ${m.estado === 'calificado'
                ? '<span class="inline-flex px-2 py-0.5 rounded-lg border bg-green-100 text-green-700 border-green-200 text-xs">Calificado</span>'
                : '<span class="inline-flex px-2 py-0.5 rounded-lg border bg-gray-100 text-gray-600 border-gray-200 text-xs">Pendiente</span>'
              }
            </td>
          </tr>
        `).join('');

        return `
          <div class="bg-white rounded-2xl shadow p-4 space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-base font-semibold">${g.curso.titulo}</h3>
                <div class="text-xs text-gray-500">Sede: ${g.curso.sede} · Aula: ${g.curso.aula}</div>
              </div>
              <div>${badgeProm(g.promedio_curso)}</div>
            </div>
            <div class="text-xs text-gray-500">Módulos calificados: ${g.calificados} / ${g.total_modulos}</div>
            <div class="overflow-auto">
              <table class="min-w-full text-sm">
                <thead class="border-b">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">#</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Módulo</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Nota</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Estado</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  ${rows || '<tr><td colspan="4" class="px-3 py-2 text-gray-500">Sin módulos</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');

      sectionContent.innerHTML = html;
      feather.replace();
    }

    // === PAGOS (solo visualización) ===
    async function renderPagos() {
      sectionTitle.textContent = 'Pagos';
      sectionActions.innerHTML = '';

      let estado = { cuotas: [] };
      let historial = { history: [] };
      try { estado = await fetchJSON('../backend/payments_status.php'); } catch(e) {}
      try { historial = await fetchJSON('../backend/payments_history.php'); } catch(e) {}

      const cuotas = estado.cuotas || [];
      const history = historial.history || [];

      const rowsEstado = cuotas.map(c => `
        <tr>
          <td class="px-3 py-2">${c.curso || '-'}</td>
          <td class="px-3 py-2">#${c.nro}</td>
          <td class="px-3 py-2">${c.vence_en}</td>
          <td class="px-3 py-2">S/ ${Number(c.monto).toFixed(2)}</td>
          <td class="px-3 py-2">
            ${c.status === 'pagado' ? '<span class="inline-flex items-center px-2 py-0.5 rounded-lg border bg-green-100 text-green-700 border-green-200 text-xs">Pagado</span>' :
              c.status === 'vencido' ? '<span class="inline-flex items-center px-2 py-0.5 rounded-lg border bg-red-100 text-red-700 border-red-200 text-xs">Vencido</span>' :
              '<span class="inline-flex items-center px-2 py-0.5 rounded-lg border bg-yellow-100 text-yellow-700 border-yellow-200 text-xs">Pendiente</span>'}
          </td>
        </tr>`).join('');

      const rowsHist = history.map(p => `
        <tr>
          <td class="px-3 py-2">${p.fecha}</td>
          <td class="px-3 py-2">S/ ${Number(p.monto).toFixed(2)}</td>
          <td class="px-3 py-2">${p.metodo}</td>
          <td class="px-3 py-2"><code class="text-xs">${p.ref}</code></td>
          <td class="px-3 py-2">${p.curso || '-'}</td>
          <td class="px-3 py-2">#${p.cuota_nro ?? '-'}</td>
        </tr>`).join('');

      sectionContent.innerHTML = `
        <div class="space-y-6">
          <div>
            <h3 class="font-semibold mb-2">Estado de cuotas</h3>
            ${table(['Curso','Cuota','Vence','Monto','Estado'], rowsEstado || '<tr><td colspan="5" class="px-3 py-2 text-gray-500">Sin cuotas</td></tr>')}
          </div>
          <div>
            <h3 class="font-semibold mb-2">Historial de pagos</h3>
            ${table(['Fecha','Monto','Método','Referencia','Curso','Cuota'], rowsHist || '<tr><td colspan="6" class="px-3 py-2 text-gray-500">Sin pagos registrados</td></tr>')}
          </div>
        </div>`;
      feather.replace();
    }

    // === PERFIL (avatar + contraseña) ===
    async function renderPerfil() {
      sectionTitle.textContent = 'Perfil';

      let profile = null;
      try {
        const j = await fetchJSON('../backend/profile_get.php');
        profile = j.user || null;
      } catch (e) {
        profile = { name:'', email:'', dni:'', phone:'', avatar_url:'' };
      }

      sectionContent.innerHTML = `
        <div class="bg-white rounded-2xl shadow p-4 space-y-6">
          <form id="profileForm" class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-gray-600">Nombre</label>
              <input name="name" type="text" value="${profile.name || ''}" class="w-full mt-1 px-3 py-2 border rounded-xl">
            </div>
            <div>
              <label class="text-sm text-gray-600">Correo</label>
              <input name="email" type="email" value="${profile.email || ''}" class="w-full mt-1 px-3 py-2 border rounded-xl">
            </div>
            <div>
              <label class="text-sm text-gray-600">Celular</label>
              <input name="phone" type="text" value="${profile.phone || ''}" class="w-full mt-1 px-3 py-2 border rounded-xl">
            </div>
            <div>
              <label class="text-sm text-gray-600">DNI</label>
              <input name="dni" type="text" value="${profile.dni || ''}" class="w-full mt-1 px-3 py-2 border rounded-xl">
            </div>
            <div class="md:col-span-2">
              <label class="text-sm text-gray-600">Foto de perfil</label>
              <div class="mt-1 flex items-center gap-3">
                <img id="avatarPreview" src="${profile.avatar_url || 'https://via.placeholder.com/80x80?text=Avatar'}" class="w-16 h-16 rounded-xl object-cover border" alt="avatar">
                <input name="avatar" id="avatarInput" type="file" accept="image/*" class="text-sm">
              </div>
              <p class="text-xs text-gray-500 mt-1">Formatos permitidos: JPG, PNG, WebP (máx. 2MB).</p>
            </div>
            <div class="md:col-span-2 grid md:grid-cols-3 gap-4">
              <div>
                <label class="text-sm text-gray-600">Contraseña actual</label>
                <input name="current_password" type="password" class="w-full mt-1 px-3 py-2 border rounded-xl">
              </div>
              <div>
                <label class="text-sm text-gray-600">Nueva contraseña</label>
                <input name="new_password" type="password" class="w-full mt-1 px-3 py-2 border rounded-xl">
              </div>
              <div>
                <label class="text-sm text-gray-600">Repetir nueva contraseña</label>
                <input name="new_password_confirm" type="password" class="w-full mt-1 px-3 py-2 border rounded-xl">
              </div>
            </div>
            <div class="md:col-span-2 flex items-center justify-end gap-2">
              <button type="button" id="btnSaveProfile" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">
                <i data-feather="save"></i> Guardar cambios
              </button>
            </div>
          </form>
          <div id="profileMsg" class="text-sm"></div>
        </div>`;
      feather.replace();

      const avatarInput = document.getElementById('avatarInput');
      const avatarPreview = document.getElementById('avatarPreview');
      avatarInput?.addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        avatarPreview.src = URL.createObjectURL(f);
      });

      document.getElementById('btnSaveProfile')?.addEventListener('click', async () => {
        const form = document.getElementById('profileForm');
        const fd = new FormData(form);
        try {
          const res = await fetch('../backend/profile_update.php', { method:'POST', body: fd });
          const data = await res.json();
          const box = document.getElementById('profileMsg');
          if (!res.ok || !data.ok) { box.className = 'text-red-700'; box.textContent = data.msg || 'Error al actualizar'; return; }
          box.className = 'text-green-700'; box.textContent = data.msg || 'Perfil actualizado';
          if (data.avatar_url) avatarPreview.src = data.avatar_url;
        } catch(e) {
          const box = document.getElementById('profileMsg');
          box.className = 'text-red-700'; box.textContent = 'Error de red o servidor';
        }
      });
    }

    // === CERTIFICADOS (regla de 10 módulos completados) ===
    async function renderCertificados() {
      sectionTitle.textContent = 'Certificados';
      sectionActions.innerHTML = '';

      let certs = [];
      try {
        const j = await fetch('../backend/certificates_list.php').then(r => r.json());
        certs = j.data || [];
      } catch (e) { certs = []; }

      if (!certs.length) {
        sectionContent.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow text-sm text-gray-700">
            No hay información de certificados por ahora.
          </div>`;
        feather.replace();
        return;
      }

      const html = certs.map(c => {
        const estadoBadge = c.status === 'disponible'
          ? '<span class="inline-flex items-center px-2 py-0.5 rounded-lg border bg-green-100 text-green-700 border-green-200 text-xs">Disponible</span>'
          : '<span class="inline-flex items-center px-2 py-0.5 rounded-lg border bg-gray-100 text-gray-700 border-gray-200 text-xs">No disponible</span>';

        const reqs = (c.requisitos || []).map(r => `<li>${r}</li>`).join('');
        const progreso = `
          <div class="mt-3">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">Módulos completados</span>
              <span class="font-medium">${c.completados || 0} / 10</span>
            </div>
            <div class="w-full h-2 bg-gray-100 rounded-full">
              <div class="h-2 rounded-full bg-indigo-600" style="width:${Math.min(100, Math.round(((c.completados||0)/10)*100))}%"></div>
            </div>
            ${c.faltan > 0 ? `<div class="mt-1 text-xs text-gray-500">Te faltan ${c.faltan} módulo(s).</div>` : ''}
          </div>
        `;

        const descarga = (c.status === 'disponible' && c.link_descarga)
          ? `<a href="${c.link_descarga}" target="_blank" class="inline-flex items-center gap-1 text-indigo-600 hover:underline">
               <i data-feather="download"></i> Descargar PDF
             </a>`
          : `<span class="text-sm text-gray-500">Aún no disponible</span>`;

        return `
          <div class="bg-white rounded-2xl shadow p-4 space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-base font-semibold">${c.title}</h3>
              ${estadoBadge}
            </div>
            <div>
              <div class="text-gray-600 mb-1 text-sm">Requisitos</div>
              <ul class="list-disc list-inside space-y-1 text-sm">${reqs}</ul>
            </div>
            ${progreso}
            <div class="pt-3 border-t">
              ${descarga}
            </div>
          </div>
        `;
      }).join('');

      sectionContent.innerHTML = html;
      feather.replace();
    }

    // === NOTIFICACIONES (lee/mark read) ===
    async function renderNotificaciones() {
      sectionTitle.textContent = 'Notificaciones';
      sectionActions.innerHTML = `
        <button id="btnMarkAll" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border hover:bg-gray-50">
          <i data-feather="check-square"></i> Marcar todas como leídas
        </button>
      `;

      let resp = { items: [], unread: 0 };
      try {
        resp = await fetch('../backend/notifications_list.php').then(r => r.json());
      } catch (e) {}

      const items = resp.items || [];
      const unread = resp.unread || 0;

      const dot = document.getElementById('notifDot');
      if (dot) dot.classList.toggle('hidden', unread === 0);

      if (!items.length) {
        sectionContent.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow text-sm text-gray-700">
            No tienes notificaciones por ahora.
          </div>`;
        feather.replace();
        return;
      }

      const rows = items.map(n => `
        <div class="bg-white rounded-2xl shadow p-4 flex items-start gap-3 ${n.read ? '' : 'border-l-4 border-indigo-600'}">
          <div class="mt-0.5">
            <i data-feather="${n.type==='pago' ? 'credit-card' : (n.type==='sistema' ? 'info' : 'bell')}"></i>
          </div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <h4 class="font-medium">${n.title}</h4>
              <span class="text-xs text-gray-500">${n.date}</span>
            </div>
            <p class="text-sm text-gray-700 mt-1">${n.desc || ''}</p>
            ${n.read ? '' : `
              <div class="mt-2">
                <button class="text-xs text-indigo-600 hover:underline" data-read-id="${n.id}">
                  Marcar como leída
                </button>
              </div>`}
          </div>
        </div>
      `).join('');

      sectionContent.innerHTML = rows;
      feather.replace();

      // Marcar una
      sectionContent.querySelectorAll('[data-read-id]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-read-id');
          const fd = new FormData();
          fd.append('ids[]', id);
          try {
            await fetch('../backend/notifications_mark_read.php', { method:'POST', body: fd });
            renderNotificaciones();
          } catch(e){}
        });
      });

      // Marcar todas
      document.getElementById('btnMarkAll').addEventListener('click', async () => {
        const fd = new FormData();
        fd.append('all', '1');
        try {
          await fetch('../backend/notifications_mark_read.php', { method:'POST', body: fd });
          renderNotificaciones();
        } catch(e){}
      });
    }

    // === Router simple ===
    const actionsBySection = {
      cursos: renderCursos,
      modulos: renderModulos,
      asistencias: renderAsistencias,
      notas: renderNotas,
      pagos: renderPagos,
      perfil: renderPerfil,
      certificados: renderCertificados,
      notificaciones: renderNotificaciones
    };
    function loadSection(id) {
      sectionActions.innerHTML = '';
      sectionContent.innerHTML = `
        <div class="bg-white rounded-2xl p-6 shadow flex items-center gap-3 text-gray-600">
          <i data-feather="loader" class="animate-spin"></i> Cargando...
        </div>`;
      feather.replace();
      (actionsBySection[id] || renderCursos)();
    }

    // Sidebar
    document.querySelectorAll('.section-btn').forEach(btn => btn.addEventListener('click', () => loadSection(btn.dataset.section)));
    document.getElementById('btnNotifications').addEventListener('click', () => loadSection('notificaciones'));

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try { await fetch('../backend/logout.php'); } catch(e){}
      window.location.href = './login.html';
    });

    // Check sesión y abrir cursos
    (async function init() {
      try {
        const s = await fetch('../backend/session_check.php');
        if (!s.ok) return location.href = './login.html';
        const data = await s.json();
        if (!data.ok || !data.auth) return location.href = './login.html';
      } catch(e) { return location.href = './login.html'; }
      loadSection('cursos');
    })();
  </script>
</body>
</html>
